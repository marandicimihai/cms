services:
  cms.app:
    image: cms.app
    container_name: cms-app
    build:
      context: .
      dockerfile: src/CMS.Main/Dockerfile
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=db;Port=5432;Database=CMS;Username=postgres;Password=postgres;Include Error Detail=true
      - EmailSettings__Smtp__Host=smtp4dev
      - EmailSettings__Smtp__Port=25
    depends_on:
      db:
        condition: service_healthy
      smtp4dev:
        condition: service_started
  db:
    image: postgres:latest
    container_name: cms-db
    environment:
      - POSTGRES_DB=CMS
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - ./.containers/postgresql:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
  smtp4dev:
    image: rnwood/smtp4dev:v3
    container_name: cms-smtp4dev
    restart: always
    ports:
      # Change the number before : to the port the web interface should be accessible on
      - '9004:80'
      # Change the number before : to the port the SMTP server should be accessible on
      - '587:25'
      # Change the number before : to the port the IMAP server should be accessible on
      - '143:143'
    volumes:
      # This is where smtp4dev stores the database..
      - ./.containers/smtp4dev-data:/smtp4dev
    environment:
      # Uncomment to customise these settings
      # This is not a complete list of the available settings.
      # See the documentation in appsettings.json for a full list.
      
      #Specifies the virtual path from web server root where SMTP4DEV web interface will be hosted. e.g. "/" or "/smtp4dev"
      #- ServerOptions__BasePath=/smtp4dev
      
      #Specifies the URLs the web UI will use inside the container.
      - ServerOptions__Urls=http://*:80
      
      #Specifies the server hostname. Used in auto-generated TLS certificate if enabled.
      - ServerOptions__HostName=smtp4dev
      
      #Locks settings from being changed by user via web interface
      #- ServerOptions__LockSettings=true
      
      #Specifies the path where the database will be stored relative to APPDATA env var on Windows or XDG_CONFIG_HOME on non-Windows. Specify "" to use an in memory database.
      #- ServerOptions__Database=database.db
      
      #Specifies the number of messages to keep
      #- ServerOptions__NumberOfMessagesToKeep=100
      
      #Specifies the number of sessions to keep
      #- ServerOptions__NumberOfSessionsToKeep=100
      
      #Specifies the TLS mode to use. None=Off. StartTls=On demand if client supports STARTTLS. ImplicitTls=TLS as soon as connection is established.
      #- ServerOptions__TlsMode=StartTls
      
      #Specifies the TLS certificate to use if TLS is enabled/requested. Specify "" to use an auto-generated self-signed certificate (then see console output on first startup)
      #- ServerOptions__TlsCertificate=""
      
      #Specifies a mailbox with name "Test" and recipient "hello@world.com". To add more, use the same format but replace the number at the end of the variable name.
      #- ServerOptions__Mailboxes__0=Test=hello@world.com
      
      #Sets the name of the SMTP server that will be used to relay messages or "" if messages should not be relayed
      #- RelayOptions__SmtpServer=
      
      #Sets the port number for the SMTP server used to relay messages.
      #- RelayOptions__SmtpPort=25
      
      #Specifies a comma separated list of recipient addresses for which messages will be relayed. An empty list means that no messages are relayed.
      #- RelayOptions__AllowedEmailsString=
      
      #Specifies the address used in MAIL FROM when relaying messages. (Sender address in message headers is left unmodified). The sender of each message is used if not specified.
      #- RelayOptions__SenderAddress=
      
      #The username for the SMTP server used to relay messages. If "" no authentication is attempted.
      #- RelayOptions__Login=
      
      #The password for the SMTP server used to relay messages
      #- RelayOptions__Password=
      
      #Specifies the port the IMAP server will listen on - allows standard email clients to view/retrieve messages
      #"ServerOptions__ImapPort"=143